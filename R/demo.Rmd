---
title: "Big_match - Testing and Demo"
author: "Rachael 'Rocky' Aikens, Voight Lab"
date: "August 24, 2018"
output:
  pdf_document: default
  html_document: default
---

This R markdown document is used for testing and demoing the current functionality of bigmatch.  We'll use the sample data from the MatchIt package for basic testing.

```{r, warning=FALSE, message = FALSE}
library(MatchIt)
library(ggplot2)
library(ggpubr)
library(dplyr)

data("lalonde")
source('big_match.R')
source('class_functions.R')

# adding a binary outcome
lalonde$outcome <- lalonde$re78 > 15000
lalonde$re78 <- NULL

# changing name of treat column to "treated" to demonstrate that any name will suffice
names(lalonde)[names(lalonde) == "treat"] <- "treated"
```

\pagebreak

# Stratify

## Manual Stratify

### Testing errors and warnings

This call should return an error because "educ" is a continuous variable.

```{r, eval = FALSE}
# manual stratification with a continuous variable 
m.strat <- manual_stratify(lalonde, treat = "treat",
                           covariates = c("black", "hispan", "educ", "nodegree"))

# Error in warn_if_continuous(data[, covariates[i]], covariates[i]) : 
#   There are 19 distinct values for educ. Is it continuous?

# manual stratification with a continuous variable, force = TRUE 
m.strat <- manual_stratify(lalonde, treat = "treat",
                           covariates = c("black", "hispan", "educ", "nodegree"), force = TRUE)

# There are 19 distinct values for educ. Is it continuous?
```

### Testing Functionality with Valid Inputs

This call should return six strata (since black and hispanic seem to be mutually exclusive categories in this dataset).

```{r}
# allowable manual stratification
m.strat <- manual_stratify(lalonde, treat = "treated",
                           covariates = c("black", "hispan", "nodegree"))
```

\pagebreak

## Auto Stratify

### Testing Errors and Warnings

First, testing error handling. These should fail and/or give warnings.

```{r, eval=FALSE}
# auto stratification with missing arguements
a.strat <- auto_stratify(lalonde, "treat", "outcome")

# Error in auto_stratify(lalonde, "treat", "outcome") : 
#   At least one of covariates and prog_scores should be specified.
```

```{r, eval = FALSE}
# auto stratification with covariates and prog scores specified, and prog_scores invalid
a.strat <- auto_stratify(lalonde, "treat", "outcome", c("age", "educ"), prog_scores = 1:4)

# covariates and prog_scores are both specified. Using prog_scores; ignoring covariates.
# Error in auto_stratify(lalonde, "treat", "outcome", c("age", "educ"), :
#   prog_scores must be the same length as the data
```

### Testing Functionality with Valid Inputs

These should give valid results.

```{r}
# auto stratification with pre-specified prognostic score
myprogscore <- runif(n = dim(lalonde)[1])
a.strat1 <- auto_stratify(data = lalonde, "treated", "outcome",
                          prog_scores = myprogscore, size = 100)

# auto stratification
a.strat2 <- auto_stratify(lalonde, "treated", "outcome", 
                          covariates = c("age", "educ", "hispan", "nodegree", "black"), 
                          size = 100)

# auto stratification with a non-continuous prognostic score
a.strat3 <- auto_stratify(lalonde, "treated", "outcome", 
                          covariates = c("hispan", "nodegree", "black"), size = 100 )
```

\pagebreak

# Diagnostics

Most of this is implemented with the generic functions `print`, `summary`, and `plot`.

## Print

```{r}
print(m.strat)

print(a.strat1)
print(a.strat2)
```

\pagebreak

## Summary

```{r}
# TODO: implement summary methods
summary(m.strat)

summary(a.strat1)
summary(a.strat2)
```

\pagebreak

## Plot

There are three types of plots: `"scatter"`, `"residual"`, and `"hist"`. Any other plot options for a strata object will throw an error.

```{r, eval = FALSE}
plot(m.strat, type = "QQ") 
# Error in plot.strata(m.strat, type = "QQ") : 
#   Not a recognized plot type.
```


### Auto and Manual Stratify : Size-Balance Scatterplot 

Below are the basic size $\times$ control fraction scatterplots for (A) manual stratification by `black`, `hispan` and `nodegree`, (B) auto-stratification with a uniform random prognostic score, (C) auto-stratification with a prognostic score that is relatively continuous, and (D) auto-stratification with a prognostic score that is discontinuous (built solely from discrete variables with few distinct values).  As you can see, this sample data contains a relatively small number of examples to begin with, so most strata are quite small. 

```{r, fig.height = 6.5}
a <- plot(m.strat) # equivalently: plot(m.strat, type = "scatter")
b <- plot(a.strat1)
c <- plot(a.strat2)
d <- plot(a.strat3) 

ggarrange(a, b, c, d, ncol = 2, nrow = 2,
          labels = "AUTO")
```

### Auto Stratify: Prognostic Score Residual Plot

This function is only meant for auto-stratified data for which prognostic scores were not prespecified.  Running it on a `manual_strata` object or an `auto_strata` object where prognostic scores were prespecified will throw an error.

```{r, eval = FALSE}
plot(m.strat, type = "residual") 
# Error in plot.strata(m.strat, type = "residual") : 
#   Prognostic score residual plots are only valid for auto-stratified data.

plot(a.strat1, type = "residual")
# Error in plot.strata(a.strat1, type = "residual"):
#  Cannot make prognostic score residual plots. Prognostic model is unknown.
```

```{r}
# TODO: implement this plot
plot(a.strat2, type = "residual")
```

### Auto Stratify: Prognostic Score Histograms 

This function is only meant for auto-stratified data.  Running it on a `manual_strata` object will throw an error.

```{r, eval = FALSE}
plot(m.strat, type = "hist")

# Error in plot.strata(m.strat, type = "hist"):
#  Prognostic score histograms are only valid for auto-stratified data.
```


```{r, fig.height=6.5}
# uniformly generated prognostic score. Nicely continuous from 0 to 1
a <- plot(a.strat1, type = "hist")

# prognostic score generated from some continuous and some distcrete variables. 
# Fairly continuous
b <- plot(a.strat2, type = "hist")

# prognostic score generated from only a few discrete variables.  
# Since prog_score only takes on a few different values, 
# strata quantiles are less evenly distributed from 0 to 1
c <- plot(a.strat3, type = "hist")

ggarrange(a, b, c, ncol = 1, nrow = 3, labels = "AUTO")
```


# Matching