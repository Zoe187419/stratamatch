---
title: "BigMatch Example with Real Data"
author: "Rachael Caelie (Rocky) Aikens"
date: "8/28/2019"
output: pdf_document
---


# Applying BigMatch to Real Data: the Lalonde Study

```{r, warning=FALSE, message = FALSE}
library(MatchIt)
library(BigMatch)

data("lalonde")

# adding a binary outcome
lalonde$outcome <- lalonde$re78 > 15000
lalonde$re78 <- NULL

# changing name of treat column to "treated" to demonstrate that any name will suffice
names(lalonde)[names(lalonde) == "treat"] <- "treated"
```

\pagebreak

# Stratify
## Manual Stratify

This call should return six strata (since black and hispanic seem to be mutually exclusive categories in this dataset).

```{r}
m.strat <- manual_stratify(lalonde, treated ~ black + hispan + nodegree)
```

\pagebreak

## Auto Stratify

These should give valid results.

```{r}
# auto stratification with pre-specified prognostic score
myprogscore <- runif(n = dim(lalonde)[1])
a.strat1 <- auto_stratify(data = lalonde, "treated", "outcome",
                          prog_scores = myprogscore, size = 100)

# auto stratification
a.strat2 <- auto_stratify(lalonde, "treated", "outcome",
                          prog_formula = outcome ~ age + educ + hispan + nodegree + black,
                          size = 100)

# auto stratification with a non-continuous prognostic score
a.strat3 <- auto_stratify(lalonde, "treated", "outcome", 
                          prog_formula = outcome ~ hispan + nodegree + black, size = 100)
```

\pagebreak

# Diagnostics

Most of this is implemented with the generic functions `print`, `summary`, and `plot`.

## Print

```{r}
print(m.strat)

print(a.strat1)
print(a.strat2)
```

\pagebreak

## Summary

```{r}
# TODO: implement summary methods
summary(m.strat)

summary(a.strat1)
summary(a.strat2)
```

\pagebreak

## Plot

There are three types of plots: `"scatter"`, `"residual"`, and `"hist"`. Any other plot options for a strata object will throw an error.

```{r, eval = FALSE}
plot(m.strat, type = "QQ") 
# Error in plot.strata(m.strat, type = "QQ") : 
#   Not a recognized plot type.
```


### Auto and Manual Stratify : Size-Balance Scatterplot 

Below are the basic size $\times$ control fraction scatterplots for (A) manual stratification by `black`, `hispan` and `nodegree`, (B) auto-stratification with a uniform random prognostic score, (C) auto-stratification with a prognostic score that is relatively continuous, and (D) auto-stratification with a prognostic score that is discontinuous (built solely from discrete variables with few distinct values).  As you can see, this sample data contains a relatively small number of examples to begin with, so most strata are quite small. 

```{r, fig.height = 6.25}
a <- plot(m.strat, label = TRUE) # equivalently: plot(m.strat, type = "scatter")
b <- plot(a.strat1, label = TRUE)
c <- plot(a.strat2, label = TRUE)
d <- plot(a.strat3, label = TRUE) 

ggpubr::ggarrange(a, b, c, d, ncol = 2, nrow = 2,
          labels = "AUTO")
```

### Auto Stratify: Prognostic Score Residual Plot

This function is only meant for auto-stratified data for which prognostic scores were not prespecified.  Running it on a `manual_strata` object or an `auto_strata` object where prognostic scores were prespecified will throw an error.

```{r, eval = FALSE}
plot(m.strat, type = "residual") 
# Error in plot.strata(m.strat, type = "residual") : 
#   Prognostic score residual plots are only valid for auto-stratified data.

plot(a.strat1, type = "residual")
# Error in plot.strata(a.strat1, type = "residual"):
#  Cannot make prognostic score residual plots. Prognostic model is unknown.
```

```{r}
# TODO: implement this plot
plot(a.strat2, type = "residual")
```

### Auto Stratify: Prognostic Score Histograms 

This function is only meant for auto-stratified data.  Running it on a `manual_strata` object will throw an error.

```{r, eval = FALSE}
plot(m.strat, type = "hist")

# Error in plot.strata(m.strat, type = "hist"):
#  Prognostic score histograms are only valid for auto-stratified data.
```


```{r, fig.height=6.5}
# uniformly generated prognostic score. Nicely continuous from 0 to 1
a <- plot(a.strat1, type = "hist")

# prognostic score generated from some continuous and some distcrete variables. 
# Fairly continuous
b <- plot(a.strat2, type = "hist")

# prognostic score generated from only a few discrete variables. 
# Since prog_score only takes on a few different values,
# strata quantiles are less evenly distributed from 0 to 1
c <- plot(a.strat3, type = "hist")

ggpubr::ggarrange(a, b, c, ncol = 1, nrow = 3, labels = "AUTO")
```


# Matching

Below, we run a default big match: the propensity score is built on the analysis set based on all covariates, stratified by stratum assignment. This implementation of big_match is essentially a wrapper for pairmatch from the optmatch package.

```{r}
summary(big_match(a.strat1))
summary(big_match(a.strat2))
summary(big_match(a.strat3)) # throws a warning
summary(big_match(m.strat)) # throws a warning
```

One can also specify the propensity score formula:

```{r}
summary(big_match(a.strat2, propensity_formula = treated ~ educ))
```

